- block:
    - name: Ensure LLDP Daemon stopped
      become: yes
      supervisorctl: state=stopped name={{ item }}
      vars:
        ansible_shell_type: docker
        ansible_python_interpreter: docker exec -i lldp python
      with_items:
        - lldp-syncd
        - lldpd

    - name: Disable bgpd
      become: yes
      lineinfile: dest=/etc/quagga/daemons
                  regexp=^bgpd=.*$
                  line='bgpd=no'
      notify:
        - Restart Quagga Daemon
      vars:
        ansible_shell_type: docker
        ansible_python_interpreter: docker exec -i bgp python

    - meta: flush_handlers

    - name: Unpause port 4
      switch_port: port=Ethernet4 pause=no

    - name: Unpause port 8
      switch_port: port=Ethernet8 pause=no

    - name: copy base test class
      copy: src=roles/test/files/acstests dest=/root
      delegate_to: "{{ ptf_host }}"
      tags: qos

    - include: dscp_mapping.yml
      tags: qos,qos_dscp_mapping

    - include: ecn_limit.yml
      tags: qos,qos_ecn_limit
      vars:
         ecn: 0
         dscp: 8
         queue: "1"
         packet_num: 5000
         limit: 500

    - include: ecn_limit.yml
      tags: qos,qos_ecn_limit
      vars:
         ecn: 1
         dscp: 8
         queue: "1"
         packet_num: 30000
         limit: 4726

    - include: ecn_limit.yml
      tags: qos,qos_ecn_limit
      vars:
         ecn: 0
         dscp: 0
         queue: "0"
         packet_num: 5000
         limit: 500

    - include: ecn_limit.yml
      tags: qos,qos_ecn_limit
      vars:
         ecn: 1
         dscp: 0
         queue: "0"
         packet_num: 30000
         limit: 4726

    - include: xoff_limit.yml
      tags: qos,qos_xoff_limit,tt
      vars:
         ecn: 0
         dscp: 3
         queue: "3"
         egress_pipe_leak: 48
         xon_limit: 177
         xoff_limit: 370

    - include: xoff_limit.yml
      tags: qos,qos_xoff_limit,tt
      vars:
         ecn: 0
         dscp: 4
         queue: "4"
         egress_pipe_leak: 48
         xon_limit: 177
         xoff_limit: 370

    - include: lossless_egress_buffer.yml
      tags: qos,qos_lossless_egress_buffer
      vars:
         ecn: 0
         dscp: 3
         queue: "3"
         egress_pipe_leak: 48
         xon_limit: 177
         xoff_limit: 370

    - include: lossless_egress_buffer.yml
      tags: qos,qos_lossless_egress_buffer
      vars:
         ecn: 0
         dscp: 4
         queue: "4"
         egress_pipe_leak: 48
         xon_limit: 177
         xoff_limit: 370

    - include: xon_limit.yml
      tags: qos,qos_xon_limit
      vars:
         ecn: 0
         dscp: 3
         queue: "3"
         egress_pipe_leak: 48
         xon_limit: 177
         xoff_limit: 370
         xoff_limit_prime: 177

    - include: xon_limit.yml
      tags: qos,qos_xon_limit
      vars:
         ecn: 0
         dscp: 4
         queue: "4"
         egress_pipe_leak: 48
         xon_limit: 177
         xoff_limit: 370
         xoff_limit_prime: 177

  always:
    - name: Restore LLDP Daemon
      become: yes
      supervisorctl: state=started name={{ item }}
      vars:
        ansible_shell_type: docker
        ansible_python_interpreter: docker exec -i lldp python
      with_items:
        - lldpd
        - lldp-syncd

    - name: Enable bgpd
      become: yes
      lineinfile: dest=/etc/quagga/daemons
                  regexp=^bgpd=.*$
                  line='bgpd=yes'
      notify:
        - Restart Quagga Daemon
      vars:
        ansible_shell_type: docker
        ansible_python_interpreter: docker exec -i bgp python

    - meta: flush_handlers

